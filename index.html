<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XMR Mining</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }
        button {
            padding: 10px 20px;
            margin: 10px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
        }
        #status {
            margin: 20px 0;
            font-weight: bold;
        }
        #hashrate {
            font-size: 18px;
            margin: 10px 0;
        }
        #threads {
            width: 60px;
        }
        .input-group {
            margin: 10px 0;
        }
        .input-group label {
            display: inline-block;
            width: 150px;
            text-align: right;
            margin-right: 10px;
        }
        #log {
            height: 120px;
            width: 100%;
            overflow-y: scroll;
            border: 1px solid #ccc;
            margin-top: 20px;
            text-align: left;
            font-family: monospace;
            padding: 5px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>XMR Mining</h1>
    
    <div class="input-group">
        <label for="wallet">Địa chỉ ví Monero:</label>
        <input type="text" id="wallet" size="30" placeholder="Nhập địa chỉ ví XMR của bạn">
    </div>
    
    <div class="input-group">
        <label for="pool">Địa chỉ Pool:</label>
        <input type="text" id="pool" size="30" value="pool.hashvault.pro" placeholder="Địa chỉ pool, không bao gồm port">
    </div>
    
    <div class="input-group">
        <label for="port">Port:</label>
        <input type="text" id="port" size="10" value="443" placeholder="Port">
    </div>
    
    <div class="input-group">
        <label for="threads">Số luồng CPU:</label>
        <input type="number" id="threads" value="2" min="1" max="12">
    </div>
    
    <div>
        <button id="startButton">Bắt đầu Mining</button>
        <button id="stopButton" disabled>Dừng Mining</button>
    </div>
    
    <div id="status">Trạng thái: Chờ khởi động...</div>
    <div id="hashrate">Hashrate: 0 H/s</div>
    
    <div id="log"></div>

    <!-- Thêm thư viện CryptoNote -->
    <script src="https://cdn.jsdelivr.net/gh/nimiq/mining-js@master/dist/mining.js"></script>
    
    <script>
        // Biến toàn cục
        let miners = [];
        let totalHashRate = 0;
        let isRunning = false;
        let hashrateInterval = null;
        let totalHashes = 0;
        
        // Các phần tử DOM
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const status = document.getElementById('status');
        const hashrate = document.getElementById('hashrate');
        const logElement = document.getElementById('log');
        
        // Hàm ghi log
        function addLog(message) {
            const now = new Date();
            const timestamp = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
            logElement.innerHTML += `[${timestamp}] ${message}<br>`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        // Kiểm tra xem trình duyệt có hỗ trợ Web Workers không
        if (typeof Worker === 'undefined') {
            status.textContent = 'Lỗi: Trình duyệt của bạn không hỗ trợ Web Workers';
            startButton.disabled = true;
            addLog('Trình duyệt không hỗ trợ Web Workers, không thể mining');
        } else {
            addLog('Trình duyệt hỗ trợ Web Workers, sẵn sàng mining');
            status.textContent = 'Trạng thái: Sẵn sàng';
        }
        
        // Sự kiện bắt đầu mining
        startButton.addEventListener('click', () => {
            const walletAddress = document.getElementById('wallet').value.trim();
            if (!walletAddress) {
                alert('Vui lòng nhập địa chỉ ví Monero!');
                return;
            }
            
            const poolHost = document.getElementById('pool').value.trim();
            const poolPort = document.getElementById('port').value.trim();
            if (!poolHost || !poolPort) {
                alert('Vui lòng nhập địa chỉ pool và port!');
                return;
            }
            
            const threadCount = parseInt(document.getElementById('threads').value) || 2;
            
            status.textContent = 'Trạng thái: Đang khởi tạo...';
            addLog('Khởi tạo mining...');
            
            try {
                // Dừng các miner hiện có nếu có
                stopMining();
                
                // Kiểm tra thư viện
                if (typeof Mining === 'undefined') {
                    throw new Error('Không thể tải thư viện mining');
                }
                
                // Khởi tạo các worker cho từng luồng
                for (let i = 0; i < threadCount; i++) {
                    addLog(`Khởi tạo worker #${i+1}...`);
                    
                    const miner = new Mining.CryptoNight.Miner({
                        threads: 1,
                        pool: {
                            host: poolHost,
                            port: parseInt(poolPort),
                            user: walletAddress,
                            pass: 'x',
                            ssl: poolPort === '443' || poolPort === '8443'
                        }
                    });
                    
                    // Đăng ký sự kiện
                    miner.on('found', (job, nonce) => {
                        addLog(`Worker #${i+1} tìm thấy share: Job ${job.id}`);
                    });
                    
                    miner.on('accepted', (job) => {
                        addLog(`Share được chấp nhận: Job ${job.id}`);
                    });
                    
                    miner.on('rejected', (job) => {
                        addLog(`Share bị từ chối: Job ${job.id}`);
                    });
                    
                    miner.on('error', (error) => {
                        addLog(`Lỗi worker #${i+1}: ${error.message || error}`);
                    });
                    
                    miner.on('hashrate', (rate) => {
                        // Cập nhật hashrate cho worker này
                        miners[i].hashrate = rate;
                        
                        // Tính tổng hashrate
                        totalHashRate = miners.reduce((sum, m) => sum + (m.hashrate || 0), 0);
                    });
                    
                    // Lưu miner vào mảng
                    miners.push({
                        instance: miner,
                        hashrate: 0
                    });
                    
                    // Bắt đầu mining
                    miner.start();
                }
                
                isRunning = true;
                totalHashes = 0;
                
                // Cập nhật UI
                startButton.disabled = true;
                stopButton.disabled = false;
                status.textContent = 'Trạng thái: Đang mining';
                addLog(`Bắt đầu mining với ${threadCount} luồng, pool: ${poolHost}:${poolPort}`);
                
                // Cập nhật hashrate mỗi giây
                hashrateInterval = setInterval(() => {
                    // Tăng tổng số hashes dựa trên hashrate
                    totalHashes += totalHashRate;
                    
                    // Hiển thị hashrate
                    hashrate.textContent = `Hashrate: ${totalHashRate.toFixed(2)} H/s | Tổng: ${totalHashes.toFixed(0)} H`;
                }, 1000);
                
            } catch (error) {
                status.textContent = `Lỗi: ${error.message || error}`;
                addLog(`ERROR: ${error.message || error}`);
                console.error(error);
            }
        });
        
        // Hàm dừng mining
        function stopMining() {
            if (miners.length > 0 && isRunning) {
                // Dừng tất cả các miner
                miners.forEach((miner, index) => {
                    if (miner.instance) {
                        miner.instance.stop();
                        addLog(`Dừng worker #${index+1}`);
                    }
                });
                
                // Xóa mảng miners
                miners = [];
                isRunning = false;
                
                // Xóa interval
                if (hashrateInterval) {
                    clearInterval(hashrateInterval);
                    hashrateInterval = null;
                }
                
                // Cập nhật UI
                startButton.disabled = false;
                stopButton.disabled = true;
                hashrate.textContent = 'Hashrate: 0 H/s';
                status.textContent = 'Trạng thái: Đã dừng';
                addLog('Đã dừng mining');
            }
        }
        
        // Sự kiện dừng mining
        stopButton.addEventListener('click', stopMining);
        
        // Dừng mining khi đóng trang
        window.addEventListener('beforeunload', stopMining);
        
        // Khởi tạo
        addLog('Trang web mining đã sẵn sàng');
    </script>
</body>
</html>
