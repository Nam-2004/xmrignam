<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HashVault XMR Mining</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
            line-height: 1.6;
        }
        .container {
            background-color: #f5f5f5;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
        }
        .input-group {
            margin: 15px 0;
            text-align: left;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 10px 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:disabled {
            background-color: #cccccc;
        }
        .stats {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
        }
        .stat-box {
            flex: 1;
            background-color: #e9e9e9;
            padding: 10px;
            border-radius: 4px;
            margin: 0 5px;
        }
        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #4CAF50;
        }
        #console {
            background-color: #333;
            color: #00ff00;
            font-family: monospace;
            padding: 10px;
            border-radius: 4px;
            height: 150px;
            overflow-y: auto;
            text-align: left;
            margin-top: 20px;
        }
        .progress-bar {
            background-color: #ddd;
            border-radius: 4px;
            height: 20px;
            margin: 10px 0;
            overflow: hidden;
        }
        .progress-fill {
            background-color: #4CAF50;
            height: 100%;
            width: 0%;
            transition: width 0.5s;
        }
    </style>
</head>
<body>
    <h1>HashVault XMR Mining</h1>
    
    <div class="container">
        <div class="input-group">
            <label for="wallet">Địa chỉ ví Monero:</label>
            <input type="text" id="wallet" placeholder="Nhập địa chỉ ví XMR của bạn">
        </div>
        
        <div class="input-group">
            <label for="threads">Số luồng CPU:</label>
            <input type="number" id="threads" value="2" min="1" max="16">
        </div>
        
        <div class="input-group">
            <label for="throttle">Mức sử dụng CPU (%):</label>
            <input type="range" id="throttle" min="10" max="100" value="70">
            <div id="throttleValue">70%</div>
        </div>
        
        <div class="input-group">
            <label for="pool">Pool Mining:</label>
            <select id="pool">
                <option value="pool.hashvault.pro:443">HashVault (TLS) - pool.hashvault.pro:443</option>
                <option value="pool.hashvault.pro:80">HashVault (TCP) - pool.hashvault.pro:80</option>
            </select>
        </div>
        
        <div>
            <button id="startBtn">Bắt đầu Mining</button>
            <button id="stopBtn" disabled>Dừng Mining</button>
        </div>
    </div>
    
    <div class="container">
        <h3>Trạng thái Mining</h3>
        <div id="status">Chưa kết nối</div>
        
        <div class="progress-bar">
            <div class="progress-fill" id="progressBar"></div>
        </div>
        
        <div class="stats">
            <div class="stat-box">
                <div>Hashrate</div>
                <div class="stat-value" id="hashrate">0 H/s</div>
            </div>
            <div class="stat-box">
                <div>Shares</div>
                <div class="stat-value" id="shares">0</div>
            </div>
            <div class="stat-box">
                <div>Thời gian</div>
                <div class="stat-value" id="time">00:00:00</div>
            </div>
        </div>
        
        <div id="console"></div>
    </div>

    <!-- Thêm script mining -->
    <script>
        // Các biến toàn cục
        let miner = null;
        let startTime = null;
        let shareCount = 0;
        let timerInterval = null;
        let hashUpdateInterval = null;
        
        // Các phần tử DOM
        const walletInput = document.getElementById('wallet');
        const threadsInput = document.getElementById('threads');
        const throttleInput = document.getElementById('throttle');
        const throttleValue = document.getElementById('throttleValue');
        const poolSelect = document.getElementById('pool');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const statusEl = document.getElementById('status');
        const hashrateEl = document.getElementById('hashrate');
        const sharesEl = document.getElementById('shares');
        const timeEl = document.getElementById('time');
        const consoleEl = document.getElementById('console');
        const progressBar = document.getElementById('progressBar');
        
        // Hàm ghi log
        function log(message) {
            const now = new Date();
            const time = now.toTimeString().split(' ')[0];
            consoleEl.innerHTML += `[${time}] ${message}<br>`;
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }
        
        // Cập nhật giá trị throttle
        throttleInput.addEventListener('input', function() {
            const value = this.value;
            throttleValue.textContent = `${value}%`;
            
            if (miner) {
                // Throttle trong miner là giá trị từ 0-1, trong đó 0 là sử dụng 100% CPU
                const throttleAmount = (100 - value) / 100;
                miner.setThrottle(throttleAmount);
                log(`Đã điều chỉnh mức sử dụng CPU thành ${value}%`);
            }
        });
        
        // Hàm tạo miner
        function createMiner(walletAddress, pool, threads, throttle) {
            try {
                // Tạo đối tượng Worker để chạy mining trong background
                const workerCode = `
                    // Biến toàn cục
                    let miner = null;
                    let hashrate = 0;
                    let totalHashes = 0;
                    let isRunning = false;
                    
                    // Hàm tải script từ URL
                    function loadScript(url) {
                        return new Promise((resolve, reject) => {
                            try {
                                importScripts(url);
                                resolve();
                            } catch (e) {
                                reject(e);
                            }
                        });
                    }
                    
                    // Hàm khởi tạo và chạy miner
                    async function initMiner(config) {
                        try {
                            // Tải thư viện mining
                            await loadScript('https://cdn.jsdelivr.net/gh/nimiq/mining-js@master/dist/mining.js');
                            
                            // Kiểm tra xem thư viện đã được tải thành công chưa
                            if (typeof Mining === 'undefined') {
                                throw new Error('Không thể tải thư viện mining');
                            }
                            
                            self.postMessage({ type: 'log', message: 'Đã tải thư viện mining' });
                            
                            // Phân tích địa chỉ pool
                            const [host, port] = config.pool.split(':');
                            
                            // Khởi tạo miner
                            miner = new Mining.XMR.Miner({
                                threads: config.threads,
                                throttle: config.throttle,
                                forceASMJS: false,
                                pool: {
                                    host: host,
                                    port: parseInt(port),
                                    user: config.wallet,
                                    pass: 'x',
                                    tls: port === '443'
                                }
                            });
                            
                            // Đăng ký các sự kiện
                            miner.on('hashrate', (rate) => {
                                hashrate = rate;
                                self.postMessage({ type: 'hashrate', hashrate: rate });
                            });
                            
                            miner.on('found', () => {
                                self.postMessage({ type: 'found' });
                            });
                            
                            miner.on('accepted', () => {
                                self.postMessage({ type: 'accepted' });
                            });
                            
                            miner.on('error', (error) => {
                                self.postMessage({ 
                                    type: 'error', 
                                    message: error.message || 'Lỗi mining không xác định'
                                });
                            });
                            
                            // Bắt đầu mining
                            miner.start();
                            isRunning = true;
                            
                            // Gửi thông báo đã bắt đầu
                            self.postMessage({ type: 'started' });
                            
                            // Cập nhật tổng số hashes mỗi giây
                            setInterval(() => {
                                if (isRunning) {
                                    totalHashes += hashrate;
                                    self.postMessage({ 
                                        type: 'update', 
                                        hashrate: hashrate,
                                        totalHashes: totalHashes
                                    });
                                }
                            }, 1000);
                            
                        } catch (error) {
                            self.postMessage({ 
                                type: 'error', 
                                message: error.message || 'Không thể khởi tạo miner'
                            });
                        }
                    }
                    
                    // Xử lý tin nhắn từ main thread
                    self.onmessage = function(e) {
                        const { command, config } = e.data;
                        
                        if (command === 'start') {
                            initMiner(config);
                        } 
                        else if (command === 'stop') {
                            if (miner && isRunning) {
                                miner.stop();
                                isRunning = false;
                                self.postMessage({ type: 'stopped' });
                            }
                        }
                        else if (command === 'setThrottle') {
                            if (miner && isRunning) {
                                miner.setThrottle(config.throttle);
                            }
                        }
                    };
                `;
                
                // Tạo blob và URL cho worker
                const blob = new Blob([workerCode], { type: 'application/javascript' });
                const workerUrl = URL.createObjectURL(blob);
                
                // Khởi tạo worker
                const worker = new Worker(workerUrl);
                
                // Xử lý tin nhắn từ worker
                worker.onmessage = function(e) {
                    const data = e.data;
                    
                    switch (data.type) {
                        case 'log':
                            log(data.message);
                            break;
                            
                        case 'started':
                            statusEl.textContent = 'Đang mining';
                            statusEl.style.color = '#4CAF50';
                            startTime = new Date();
                            log('Mining đã bắt đầu');
                            
                            // Bắt đầu đếm thời gian
                            timerInterval = setInterval(updateTimer, 1000);
                            break;
                            
                        case 'stopped':
                            statusEl.textContent = 'Đã dừng';
                            statusEl.style.color = '#f44336';
                            clearInterval(timerInterval);
                            log('Mining đã dừng');
                            break;
                            
                        case 'hashrate':
                            hashrateEl.textContent = `${data.hashrate.toFixed(2)} H/s`;
                            break;
                            
                        case 'update':
                            hashrateEl.textContent = `${data.hashrate.toFixed(2)} H/s`;
                            
                            // Cập nhật thanh tiến trình (tăng 1% mỗi 100 hashes)
                            const progressPercent = Math.min(100, (data.totalHashes % 10000) / 100);
                            progressBar.style.width = `${progressPercent}%`;
                            break;
                            
                        case 'found':
                            log('Đã tìm thấy share!');
                            break;
                            
                        case 'accepted':
                            shareCount++;
                            sharesEl.textContent = shareCount;
                            log('Share được chấp nhận!');
                            break;
                            
                        case 'error':
                            statusEl.textContent = `Lỗi: ${data.message}`;
                            statusEl.style.color = '#f44336';
                            log(`Lỗi: ${data.message}`);
                            stopMining();
                            break;
                    }
                };
                
                // Xử lý lỗi worker
                worker.onerror = function(error) {
                    statusEl.textContent = `Lỗi Worker: ${error.message}`;
                    statusEl.style.color = '#f44336';
                    log(`Lỗi Worker: ${error.message}`);
                    stopMining();
                };
                
                // Gửi cấu hình và lệnh bắt đầu
                worker.postMessage({
                    command: 'start',
                    config: {
                        wallet: walletAddress,
                        pool: pool,
                        threads: threads,
                        throttle: (100 - throttle) / 100 // Chuyển đổi % thành giá trị throttle (0-1)
                    }
                });
                
                // Trả về đối tượng miner với các phương thức cần thiết
                return {
                    worker: worker,
                    stop: function() {
                        worker.postMessage({ command: 'stop' });
                    },
                    setThrottle: function(throttle) {
                        worker.postMessage({
                            command: 'setThrottle',
                            config: { throttle: throttle }
                        });
                    }
                };
                
            } catch (error) {
                log(`Lỗi khởi tạo miner: ${error.message}`);
                throw error;
            }
        }
        
        // Cập nhật thời gian chạy
        function updateTimer() {
            if (!startTime) return;
            
            const now = new Date();
            const diff = Math.floor((now - startTime) / 1000);
            
            const hours = Math.floor(diff / 3600).toString().padStart(2, '0');
            const minutes = Math.floor((diff % 3600) / 60).toString().padStart(2, '0');
            const seconds = Math.floor(diff % 60).toString().padStart(2, '0');
            
            timeEl.textContent = `${hours}:${minutes}:${seconds}`;
        }
        
        // Sự kiện bắt đầu mining
        startBtn.addEventListener('click', function() {
            const walletAddress = walletInput.value.trim();
            if (!walletAddress) {
                alert('Vui lòng nhập địa chỉ ví Monero!');
                return;
            }
            
            const threads = parseInt(threadsInput.value) || 2;
            const throttle = parseInt(throttleInput.value) || 70;
            const pool = poolSelect.value;
            
            try {
                statusEl.textContent = 'Đang kết nối...';
                statusEl.style.color = '#ff9800';
                log(`Kết nối đến ${pool} với ${threads} luồng, mức sử dụng CPU: ${throttle}%`);
                
                // Khởi tạo miner
                miner = createMiner(walletAddress, pool, threads, throttle);
                
                // Cập nhật UI
                startBtn.disabled = true;
                stopBtn.disabled = false;
                
            } catch (error) {
                statusEl.textContent = `Lỗi: ${error.message}`;
                statusEl.style.color = '#f44336';
                log(`Lỗi: ${error.message}`);
            }
        });
        
        // Hàm dừng mining
        function stopMining() {
            if (miner) {
                miner.stop();
                miner = null;
            }
            
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            startBtn.disabled = false;
            stopBtn.disabled = true;
        }
        
        // Sự kiện dừng mining
        stopBtn.addEventListener('click', stopMining);
        
        // Dừng mining khi đóng trang
        window.addEventListener('beforeunload', stopMining);
        
        // Khởi tạo
        log('Trang web mining đã sẵn sàng. Vui lòng nhập địa chỉ ví và bắt đầu mining.');
    </script>
</body>
</html>
